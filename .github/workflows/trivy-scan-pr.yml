name: Trivy Security Scan - PR

on:
  pull_request:
    branches:
      - main
      - develop
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write

jobs:
  trivy-scan-pr:
    name: Trivy PR Security Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Run Trivy scan for critical vulnerabilities
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          scanners: 'vuln'
          severity: 'CRITICAL,HIGH'
          format: 'table'
          skip-dirs: 'node_modules'
        continue-on-error: true

      - name: Run Trivy scan for secrets
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          scanners: 'secret'
          format: 'table'
          skip-dirs: 'node_modules'
          exit-code: '1'

      - name: Generate Trivy report for PR comment
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          scanners: 'vuln,secret'
          format: 'table'
          output: 'trivy-pr-report.txt'
          severity: 'CRITICAL,HIGH'
          exit-code: '0'
          skip-dirs: 'node_modules'

      - name: Post Trivy scan results to PR
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const triviaReport = fs.existsSync('trivy-pr-report.txt')
              ? fs.readFileSync('trivy-pr-report.txt', 'utf8')
              : 'No critical vulnerabilities or secrets detected.';

            const commentBody = `## ðŸ”’ Trivy Security Scan Results (PR)

            <details>
            <summary>ðŸ“Š Scan Summary</summary>

            **Scanned:** \`${context.payload.pull_request.head.sha.substring(0, 7)}\`
            **Workflow Run:** [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            **Severity Levels:** CRITICAL, HIGH

            </details>

            ### Vulnerability Report

            ${triviaReport.length > 0 ? '```\n' + triviaReport + '\n```' : '_No critical vulnerabilities or secrets found._'}

            ---
            <sub>ðŸ’¡ This is a quick scan for PR review. Full scan runs weekly on the main branch.</sub>
            <sub>ðŸ“‹ View detailed results in the [Security tab](${{ github.server_url }}/${{ github.repository }}/security/code-scanning)</sub>
            `;

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('ðŸ”’ Trivy Security Scan Results (PR)')
            );

            // Update or create comment
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: commentBody
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                body: commentBody
              });
            }
