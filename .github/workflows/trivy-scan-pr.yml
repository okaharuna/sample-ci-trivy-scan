name: Trivy Security Scan - PR

on:
  pull_request:
    branches:
      - main
      - develop
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write

jobs:
  trivy-scan-pr:
    name: Trivy PR Security Scan
    runs-on: ubuntu-latest

    steps:
      # ========================================
      # ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—: ãƒªãƒã‚¸ãƒˆãƒªã¨Pythonç’°å¢ƒ
      # ========================================

      # PRã®ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      - name: Checkout code
        uses: actions/checkout@v4

      # Pythonã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã¨pipã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®æœ‰åŠ¹åŒ–
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      # Pythonä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      # ========================================
      # Trivyã‚¹ã‚­ãƒ£ãƒ³: é«˜é€Ÿç‰ˆï¼ˆPRç”¨ï¼‰
      # ========================================

      # CRITICAL/HIGHãƒ¬ãƒ™ãƒ«ã®è„†å¼±æ€§ã®ã¿ã‚¹ã‚­ãƒ£ãƒ³ï¼ˆé«˜é€Ÿå®Ÿè¡Œï¼‰
      # ãƒ†ãƒ¼ãƒ–ãƒ«å½¢å¼ã§ãƒ­ã‚°å‡ºåŠ›
      - name: Run Trivy scan for critical vulnerabilities
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          scanners: 'vuln'
          severity: 'CRITICAL,HIGH'
          format: 'table'
          skip-dirs: 'node_modules'
        continue-on-error: true

      # ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆï¼ˆAPIã‚­ãƒ¼ã€ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãªã©ï¼‰ã‚’æ¤œå‡º
      # æ¤œå‡ºæ™‚ã¯ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’å¤±æ•—ã•ã›ã¦ãƒãƒ¼ã‚¸ã‚’ãƒ–ãƒ­ãƒƒã‚¯
      - name: Run Trivy scan for secrets
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          scanners: 'secret'
          format: 'table'
          skip-dirs: 'node_modules'
          exit-code: '1'  # ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆæ¤œå‡ºæ™‚ã¯å¤±æ•—

      # ========================================
      # PRã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿ç”¨ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
      # ========================================

      # PRã‚³ãƒ¡ãƒ³ãƒˆã«è¡¨ç¤ºã™ã‚‹ãŸã‚ã®ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
      # CRITICAL/HIGHãƒ¬ãƒ™ãƒ«ã®è„†å¼±æ€§ã¨ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚’å«ã‚€
      - name: Generate Trivy report for PR comment
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          scanners: 'vuln,secret'
          format: 'table'
          output: 'trivy-pr-report.txt'
          severity: 'CRITICAL,HIGH'
          exit-code: '0'
          skip-dirs: 'node_modules'

      # ========================================
      # PRã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿
      # ========================================

      # ã‚¹ã‚­ãƒ£ãƒ³çµæœã‚’PRã«ã‚³ãƒ¡ãƒ³ãƒˆã¨ã—ã¦æŠ•ç¨¿
      # æ—¢å­˜ã®ã‚³ãƒ¡ãƒ³ãƒˆãŒã‚ã‚‹å ´åˆã¯æ›´æ–°ï¼ˆé‡è¤‡å›é¿ï¼‰
      - name: Post Trivy scan results to PR
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            // ãƒ¬ãƒãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿
            const triviaReport = fs.existsSync('trivy-pr-report.txt')
              ? fs.readFileSync('trivy-pr-report.txt', 'utf8')
              : 'No critical vulnerabilities or secrets detected.';

            // PRã‚³ãƒ¡ãƒ³ãƒˆæœ¬æ–‡ã‚’ä½œæˆ
            const commentBody = `## ğŸ”’ Trivy Security Scan Results (PR)

            <details>
            <summary>ğŸ“Š Scan Summary</summary>

            **Scanned:** \`${context.payload.pull_request.head.sha.substring(0, 7)}\`
            **Workflow Run:** [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            **Severity Levels:** CRITICAL, HIGH

            </details>

            ### Vulnerability Report

            ${triviaReport.length > 0 ? '```\n' + triviaReport + '\n```' : '_No critical vulnerabilities or secrets found._'}

            ---
            <sub>ğŸ’¡ This is a quick scan for PR review. Full scan runs weekly on the main branch.</sub>
            <sub>ğŸ“‹ View detailed results in the [Security tab](${{ github.server_url }}/${{ github.repository }}/security/code-scanning)</sub>
            `;

            // æ—¢å­˜ã®Botã‚³ãƒ¡ãƒ³ãƒˆã‚’æ¤œç´¢
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('ğŸ”’ Trivy Security Scan Results (PR)')
            );

            // ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ›´æ–°ã¾ãŸã¯æ–°è¦ä½œæˆ
            if (botComment) {
              // æ—¢å­˜ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ›´æ–°
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: commentBody
              });
            } else {
              // æ–°è¦ã‚³ãƒ¡ãƒ³ãƒˆã‚’ä½œæˆ
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                body: commentBody
              });
            }
