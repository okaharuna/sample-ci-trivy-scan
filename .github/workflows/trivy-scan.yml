name: Trivy Security Scan

on:
  push:
    branches:
      - main
      - develop
  pull_request:
  # æ—¥æ¬¡ã‚¹ã‚­ãƒ£ãƒ³ã®ä¾‹
  # schedule:
    # Run daily at 00:00 UTC
    # - cron: '0 0 * * *'
  workflow_dispatch:

permissions:
  contents: read
  security-events: write
  actions: read
  pull-requests: write

jobs:
  trivy-scan:
    name: Trivy Security Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install Serverless Framework
        run: npm install -g serverless

      - name: Create package.json if not exists
        run: |
          if [ ! -f package.json ]; then
            echo '{"name": "sample-python-service", "version": "1.0.0"}' > package.json
          fi

      - name: Install serverless-python-requirements plugin
        run: npm install --save-dev serverless-python-requirements
        continue-on-error: true

      - name: Package Serverless application
        run: serverless package
        continue-on-error: true

      - name: Run Trivy scan on CloudFormation templates
        if: hashFiles('.serverless/*.json') != ''
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'config'
          scan-ref: '.serverless/'
          format: 'table'
          severity: 'CRITICAL,HIGH,MEDIUM'
          exit-code: '0'
        continue-on-error: true

      - name: Run Trivy scan on CloudFormation (SARIF)
        if: hashFiles('.serverless/*.json') != ''
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'config'
          scan-ref: '.serverless/'
          format: 'sarif'
          output: 'trivy-cloudformation-results.sarif'
          severity: 'CRITICAL,HIGH,MEDIUM'
          exit-code: '0'

      - name: Upload CloudFormation scan results to GitHub Security tab
        if: always() && hashFiles('trivy-cloudformation-results.sarif') != ''
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-cloudformation-results.sarif'
          category: 'trivy-cloudformation'

      - name: Run Trivy vulnerability scanner in filesystem mode
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-fs-results.sarif'
          severity: 'CRITICAL,HIGH,MEDIUM'
          scanners: 'vuln,secret,misconfig'

      - name: Upload Trivy filesystem scan results to GitHub Security tab
        if: always() && hashFiles('trivy-fs-results.sarif') != ''
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-fs-results.sarif'
          category: 'trivy-filesystem'

      - name: Run Trivy scanner for Python dependencies
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'table'
          severity: 'CRITICAL,HIGH'
          scanners: 'vuln'
          vuln-type: 'library'
        continue-on-error: true

      - name: Run Trivy configuration scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'config'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-config-results.sarif'
          severity: 'CRITICAL,HIGH,MEDIUM'
          exit-code: '0'

      - name: Upload Trivy config scan results to GitHub Security tab
        if: always() && hashFiles('trivy-config-results.sarif') != ''
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-config-results.sarif'
          category: 'trivy-config'

      - name: Run Trivy scanner for serverless.yml
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'config'
          scan-ref: 'serverless.yml'
          format: 'table'
          severity: 'CRITICAL,HIGH,MEDIUM'
        continue-on-error: true

      - name: Generate Trivy report (JSON)
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'json'
          output: 'trivy-report.json'
          severity: 'CRITICAL,HIGH,MEDIUM,LOW'
        continue-on-error: true

      - name: Generate Trivy report for PR comment
        if: github.event_name == 'pull_request'
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'table'
          output: 'trivy-pr-report.txt'
          severity: 'CRITICAL,HIGH,MEDIUM'
          exit-code: '0'

      - name: Post Trivy scan results to PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const triviaReport = fs.existsSync('trivy-pr-report.txt')
              ? fs.readFileSync('trivy-pr-report.txt', 'utf8')
              : 'No vulnerabilities detected or scan failed.';

            const commentBody = `## ðŸ”’ Trivy Security Scan Results

            <details>
            <summary>ðŸ“Š Scan Summary</summary>

            **Scanned:** \`${context.payload.pull_request.head.sha.substring(0, 7)}\`
            **Workflow Run:** [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

            </details>

            ### Vulnerability Report

            ${triviaReport.length > 0 ? '```\n' + triviaReport + '\n```' : '_No vulnerabilities found._'}

            ---
            <sub>ðŸ’¡ View detailed results in the [Security tab](${{ github.server_url }}/${{ github.repository }}/security/code-scanning)</sub>
            `;

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('ðŸ”’ Trivy Security Scan Results')
            );

            // Update or create comment
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: commentBody
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                body: commentBody
              });
            }

      - name: Upload Trivy report as artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: trivy-scan-report
          path: |
            trivy-fs-results.sarif
            trivy-config-results.sarif
            trivy-cloudformation-results.sarif
            trivy-report.json
            trivy-pr-report.txt
          retention-days: 30

      - name: Upload CloudFormation templates as artifact
        if: hashFiles('.serverless/*.json') != ''
        uses: actions/upload-artifact@v4
        with:
          name: serverless-cloudformation
          path: .serverless/
          retention-days: 30
